name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Wait for main workflow
        run: |
          TIMEOUT_MINUTES=120
          SLEEP_SECONDS=60
          attempts=0
          max_attempts=$TIMEOUT_MINUTES
          while [ $attempts -lt $max_attempts ]; do
            run_id=$(gh run list --commit ${{ github.sha }} --workflow main.yml --status completed --json databaseId,conclusion --jq '.[] | select(.conclusion == "success") | .databaseId | first')
            if [ -n "$run_id" ]; then
              echo "Found run ID: $run_id"
              echo "RUN_ID=$run_id" >> $GITHUB_ENV
              break
            fi
            echo "Waiting for main workflow to complete... ($((attempts + 1))/$max_attempts)"
            sleep $SLEEP_SECONDS
            attempts=$((attempts + 1))
          done
          if [ $attempts -eq $max_attempts ]; then
            echo "Timeout: Main workflow did not complete successfully within $TIMEOUT_MINUTES minutes."
            exit 1
          fi
      - run: gh run download $RUN_ID --name sqlite3-addon
      - run: zip -r sqlite3-addon.zip sqlite3-addon
      - run: gh release upload ${{ github.ref_name }} sqlite3-addon.zip
